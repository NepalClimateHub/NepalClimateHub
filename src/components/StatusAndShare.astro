---
interface Props {
    status: string;
}

const {status} = Astro.props;

const cleanedStatus = status.toLowerCase().trim();
const statusClass = status ? `status-${cleanedStatus}`: 'status-unknown' ;
---

<div class="container">
  <!-- event status -->
  {
    status && (<div class={`event-status ${statusClass}`}>{cleanedStatus}</div>)
  }
  <!-- Event share section -->
  <div class="event-share">
    <span class="share-label">Share:</span>
    <div class="icon-wrapper">
      <div class="copy-container">
        <!-- Copy link button -->
        <button class="copy-btn" type="button" aria-label="Copy link to clipboard">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 8V6C16 4.89543 15.1046 4 14 4H6C4.89543 4 4 4.89543 4 6V14C4 15.1046 4.89543 16 6 16H8" />
            <rect x="8" y="8" width="12" height="12" rx="2" />
         </svg>
        </button>
        <div class="copied-toast" role="status">Link copied</div>
        <div class="not-copied-toast" role="status">Failed to copy</div>
      </div>
      <!-- share to social media buttons -->
      <button
        type="button"
        class="icon share-linkedin"
        aria-label="Share on LinkedIn"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="#1A1B1E"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="icon icon-tabler icon-tabler-brand-linkedin"
        >
          <defs>
            <mask id="linkedin-mask">
              <rect width="24" height="24" fill="white" />
              <path d="M8 11v5" stroke="black" />
              <path d="M8 8v.01" stroke="black" />
              <path d="M12 16v-5" stroke="black" />
              <path d="M16 16v-3a2 2 0 1 0 -4 0" stroke="black" />
            </mask>
          </defs>
          <path
            class="linkedin-bg"
            d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z"
            mask="url(#linkedin-mask)"
          />
          <path d="M8 11v5"></path>
          <path d="M8 8v.01"></path>
          <path d="M12 16v-5"></path>
          <path d="M16 16v-3a2 2 0 1 0 -4 0"></path>
        </svg>

      </button>
      <button
        type="button"
        class="icon share-instagram"
        aria-label="Share on Instagram"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-brand-instagram"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path d="M4 8a4 4 0 0 1 4 -4h8a4 4 0 0 1 4 4v8a4 4 0 0 1 -4 4h-8a4 4 0 0 1 -4 -4z"></path>
          <path d="M9 12a3 3 0 1 0 6 0a3 3 0 0 0 -6 0"></path>
          <path d="M16.5 7.5v.01"></path>
        </svg>
      </button>
      <button
        type="button"
        class="icon share-facebook"
        aria-label="Share on Facebook"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="icon icon-tabler icons-tabler-outline icon-tabler-brand-facebook"
        >
          <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
          <path
            d="M7 10v4h3v7h4v-7h3l1 -4h-4v-2a1 1 0 0 1 1 -1h3v-4h-3a5 5 0 0 0 -5 5v2h-3"
          ></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  const copyBtn = document.querySelector('.copy-btn') as HTMLButtonElement | null;
  const copiedToast = document.querySelector('.copied-toast') as HTMLElement | null;
  const notCopiedToast = document.querySelector('.not-copied-toast') as HTMLElement | null;

  const linkedinBtn = document.querySelector('.share-linkedin') as HTMLButtonElement | null;
  const instagramBtn = document.querySelector('.share-instagram') as HTMLButtonElement | null;
  const facebookBtn = document.querySelector('.share-facebook') as HTMLButtonElement | null;

  let shouldWait = false;

  function getShareMeta() {
    const url = window.location.href;
    const title = document.title || 'Nepal Climate Hub';
    const description =
      document.querySelector('meta[name="description"]')?.getAttribute('content') ||
      'Learn more on Nepal Climate Hub.';

    return { url, title, description };
  }

  async function copyToClipboard() {
    if (!copyBtn || !copiedToast || !notCopiedToast) return;
    if (shouldWait) return;
    shouldWait = true;

    try {
      if (!navigator.clipboard) {
        throw new Error('Clipboard API not available');
      }
      await navigator.clipboard.writeText(window.location.href);
      copiedToast.style.display = 'block';
      setTimeout(function () {
        copiedToast.style.display = 'none';
        shouldWait = false;
      }, 3000);
    } catch (err) {
      notCopiedToast.style.display = 'block';
      setTimeout(function () {
        notCopiedToast.style.display = 'none';
        shouldWait = false;
      }, 3000);
    }
  }

  function openPopup(url: string) {
    const width = 600;
    const height = 600;
    const left = window.screenX + (window.outerWidth - width) / 2;
    const top = window.screenY + (window.outerHeight - height) / 2;

    window.open(
      url,
      '_blank',
      `width=${width},height=${height},left=${left},top=${top},noopener,noreferrer`
    );
  }

  function shareOnLinkedIn() {
    const { url } = getShareMeta();
    const shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(
      url
    )}`;
    openPopup(shareUrl);
  }

  function shareOnFacebook() {
    const { url, title } = getShareMeta();
    const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(
      url
    )}&quote=${encodeURIComponent(title)}`;
    openPopup(shareUrl);
  }

  async function shareOnInstagram() {
    const { url, title, description } = getShareMeta();

    // Prefer Web Share API when available (mobile browsers, some desktops)
    if (navigator.share) {
      try {
        await navigator.share({
          title,
          text: description,
          url,
        });
        return;
      } catch {
        // user cancelled or share failed â€“ silently ignore
        return;
      }
    }

    // Fallback: copy link and show "copied" toast so user can paste into Instagram
    await copyToClipboard();
  }

  copyBtn?.addEventListener('click', copyToClipboard);
  linkedinBtn?.addEventListener('click', shareOnLinkedIn);
  facebookBtn?.addEventListener('click', shareOnFacebook);
  instagramBtn?.addEventListener('click', shareOnInstagram);
</script>

<style>
  .container{
    display: flex;
    gap: 10px;
    justify-content: space-between;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }

  .event-status{
    border-radius: 16px;
    padding: 5px 12px;
    font-size: 12px;
    text-transform: capitalize;
  }
  .status-open{
    border: 1px solid #5BA300;
    background-color: #E8FFD1;
    color: #5BA300;
    font-weight: 400;
  }
  .status-ongoing{
    border: 1px solid #364FC7;
    background-color: #E8FFD1;
    color: #364FC7;
  }
  .status-closed{
    border: 1px solid #D92D20;
    background-color: #FFE5E5;
    color: #D92D20;
  }
  .status-upcoming, .status-unknown {
    border: 1px solid #CA8A04;
    background-color: #FEF3C7;
    color: #CA8A04;
  }

  .event-share{
    display: flex;
    gap: 8px;
    align-items: center;
    margin-left: auto;
  }
  .share-label{
    color: #1A1B1E;
    font-weight: 800;
  }

  .copy-container{
    position: relative;
  }
  .copy-btn{
    cursor: pointer;
    display: flex;
    align-items: center;
    border: none;
    background: none;
  }
  .copied-toast, .not-copied-toast{
    position: absolute;
    left: 0;
    bottom: 0;
    transform: translateY(110%);
    border-radius: 4px;
    color: #ffffff;
    font-size: 12px;
    background-color: #1A1B1E;
    /* border: 1px solid #cefe00; */
    text-align: center;
    padding: 6px 10px;
    white-space: nowrap;
    display: none;
  }
  .copy-btn svg, .icon svg{
    stroke: #1A1B1E;
  }
  .copy-btn:hover svg, .icon:hover svg{
    fill: #cefe00
  }
  .copy-btn:active svg, .icon:active svg{
    opacity: .3;
  }

  .icon-wrapper {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .icon{
    display: flex;
    align-items: center;
    border: none;
    background: none;
    padding: 0;
    cursor: pointer;
  }
</style>