---
import '../../styles/global.css';
import ConnectCard from '../../components/ConnectCard.astro';
import FeaturedBlogSection from '../../components/FeaturedBlogSection.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import BaseLayout from '../../layouts/Layout.astro';
import { fetchAllBlogs } from '../../api';
import { createSlug } from '../../utils/slug';
import HtmlRenderer from '../../components/HtmlRenderer.astro';

// Add this function for static generation
export async function getStaticPaths() {
  try {
    const response = await fetchAllBlogs();
    const allBlogs = response.data || [];
    
    return allBlogs.map((blog: any) => ({
      params: { detail: createSlug(blog.title) },
      props: { apiBlog: blog, allBlogs }
    }));
  } catch (error) {
    console.error('Error fetching blogs for static paths:', error);
    return [];
  }
}

// Get the props passed from getStaticPaths
const { apiBlog, allBlogs } = Astro.props;
const { detail } = Astro.params;

if (!apiBlog) {
  throw new Error(`Blog with slug ${detail} not found`);
}

const blogDetail = {
  ...apiBlog,
  bannerImage: apiBlog.bannerImageUrl || '/placeholder.svg',
  content: apiBlog.content || '',
  excerpt: apiBlog.excerpt || '',
  author: apiBlog.author || 'Unknown Author',
  category: apiBlog.category || 'General',
  readingTime: apiBlog.readingTime || '5 minutes',
  publishedDate: apiBlog.publishedDate || new Date().toISOString(),
  tags: apiBlog.tags || [],
};
---

<BaseLayout title={`${blogDetail.title} | Nepal Climate Hub`}>
  <main class="main-container">
    <!-- Header Section -->
    <section class="header-section">
      <Header logoColor="#1A1B1E" />
      <div class="mini-nav">
        <a href="/">Home</a>
        <span style="color: #364FC7">/</span>
        <a href="/blogs">Blogs</a>
      </div>
    </section>

    <!-- Blog Detail Section -->
    <section class="blog-detail-section">
      <div class="!max-w-4xl !mx-auto !px-6 lg:!px-8 md:!px-6 sm:!px-4 !py-12">
        <!-- Blog Header -->
        <div class="!text-center !mb-12">
          <h1 class="!text-4xl lg:!text-3xl md:!text-2xl !font-bold !text-gray-900 !mb-6">
            {blogDetail.title}
          </h1>
          
          <!-- Blog Meta -->
          <div class="!flex !items-center !justify-center !gap-6 !mb-6 !text-gray-600">
            <div class="!flex !items-center">
              <span class="!w-4 !h-4 !mr-2">üë§</span>
              <span>{blogDetail.author}</span>
            </div>
            <div class="!flex !items-center">
              <span class="!w-4 !h-4 !mr-2">üìÖ</span>
              <span>{new Date(blogDetail.publishedDate).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}</span>
            </div>
            <div class="!flex !items-center">
              <span class="!w-4 !h-4 !mr-2">‚è±Ô∏è</span>
              <span>{blogDetail.readingTime}</span>
            </div>
          </div>

          <!-- Category Badge -->
          <div class="!mb-8">
            <span class="!inline-flex !items-center !px-4 !py-2 !text-sm !font-medium !bg-blue-50 !text-blue-700 !border !border-blue-200 !rounded-full">
              {blogDetail.category}
            </span>
          </div>

          <!-- Tags -->
          {blogDetail.tags && blogDetail.tags.length > 0 && (
            <div class="!flex !flex-wrap !justify-center !gap-2 !mb-8">
              {blogDetail.tags.map((tag: string) => (
                <span class="!inline-flex !items-center !px-3 !py-1 !text-xs !font-medium !bg-gray-50 !text-gray-700 !border !border-gray-200 !rounded-full">
                  {tag}
                </span>
              ))}
            </div>
          )}
        </div>

        <!-- Blog Banner Image -->
        <div class="!mb-12">
          <img
            src={blogDetail.bannerImage}
            alt={blogDetail.title}
            class="!w-full !h-96 !object-cover !rounded-2xl !shadow-lg"
          />
        </div>

        <!-- Blog Content -->
        <div class="!mb-12">
          <HtmlRenderer content={blogDetail.content} />
        </div>

        <style is:global>
          /* Global so it affects set:html content (no Astro scoping) */
          #blog-content ul {
            list-style: disc !important;
            list-style-position: outside !important;
            padding-left: 1.5rem !important;
            margin: 0 0 1rem 0 !important;
          }

          #blog-content ol {
            list-style: decimal !important;
            list-style-position: outside !important;
            padding-left: 1.5rem !important;
            margin: 0 0 1rem 0 !important;
          }

          #blog-content li {
            display: list-item !important;
            list-style: inherit !important;
            margin: 0 0 0.5rem 0 !important;
          }

          #blog-content ul li::marker {
            content: '‚Ä¢ ' !important;
            color: #374151 !important;
            font-weight: 700 !important;
          }

          #blog-content ol li::marker {
            color: #374151 !important;
            font-weight: 700 !important;
          }

          #blog-content li > p,
          #blog-content li > .text-node {
            display: inline !important;
            margin: 0 !important;
          }

          #blog-content .heading-node,
          #blog-content h1,
          #blog-content h2,
          #blog-content h3 {
            font-weight: 700 !important;
            color: #111827 !important;
          }
        </style>

        <!-- Blog Footer -->
        <div class="!border-t !border-gray-200 !pt-8 !text-center !text-gray-600">
          <p>Written by <span class="!font-medium">{blogDetail.author}</span></p>
          <p class="!text-sm !mt-2">Published on {new Date(blogDetail.publishedDate).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })}</p>
        </div>
      </div>
    </section>
    
    <section class="connect-card-section">
      <ConnectCard
        organization={false}
        dataObj={blogDetail}
      />
    </section>

    <section class="other-blogs-section">
      <FeaturedBlogSection
        startIndex={0}
        endIndex={3}
        title="Other Blogs You Might Like"
        currentBlogId={apiBlog.id}
      />
    </section>

    <section class="footer-section">
      <Footer />
    </section>
  </main>
</BaseLayout>

<style>
  section {
    padding: 0px 48px;
  }

  .connect-card-section {
    background-color: #cefe00;
  }

  .footer-section {
    background-color: #1a1b1e;
    color: white;
  }

  @media screen and (max-width: 768px) {
    section {
      padding: 0px;
    }
  }
</style>