---
import '../../styles/global.css';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import BaseLayout from '../../layouts/Layout.astro';
import { fetchAllBlogs } from '../../api';
import { createSlug } from '../../utils/slug';
import HtmlRenderer from '../../components/HtmlRenderer.astro';
import EmailSubscriptionForm from '@components/EmailSubscriptionForm.astro';
import type { Blog as apiBlog } from 'src/types/blog';
import BlogHighlights from '@components/BlogHighlights.astro';
import AuthorInfoandShareBlog from '@components/AuthorInfoandShareBlog.astro';
import AboutBlogAuthor from '@components/AboutBlogAuthor.astro';

function stripHtml(html: string): string {
  return html.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim();
}

const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

const { detail } = Astro.params;

let apiBlog: apiBlog | null = null;
let allBlogs: apiBlog[] = [];

try {
  const response = await fetchAllBlogs();
  allBlogs = response.data || [];
  apiBlog = allBlogs.find(
    (blog) => createSlug(blog.title) === detail
  ) || null;
} catch (error) {
  console.error('Error fetching blogs:', error);
  // Fallback to empty data if API fails
  allBlogs = [];
  apiBlog = null;
}

if (!apiBlog) {
  throw new Error(`Blog with slug ${detail} not found`);
}

const latestBlogs: apiBlog[] = allBlogs.slice(0, 3);

const blogDetail = {
  ...apiBlog,
  bannerImage: apiBlog.bannerImageUrl || '/placeholder.svg',
  content: apiBlog.content || '',
  excerpt: apiBlog.excerpt || '',
  author: apiBlog.author || 'Unknown Author',
  category: apiBlog.category || 'General',
  readingTime: apiBlog.readingTime || '5 minutes',
  publishedDate: apiBlog.publishedDate || new Date().toISOString(),
  tags: apiBlog.tags || [],
};

const siteUrl = Astro.site || "https://nepalclimatehub.org";
const pathname = Astro.url.pathname;
const search = Astro.url.search;
const hash = Astro.url.hash;
const fullPath = `${pathname}${search}${hash}`;
const metaDescription = `${stripHtml(blogDetail.excerpt)} - ${blogDetail.author}` || `Read about ${blogDetail.title} on Nepal Climate Hub.` || `Read blog by ${blogDetail.author}.`;
const metaImage = blogDetail.bannerImage || '/favicon.png';
const metaUrl = `${siteUrl}${fullPath}`;

const socials = {
  facebook: 'https://www.facebook.com/',
  instagram: 'https://www.instagram.com/',
  linkedin: 'https://www.linkedin.com/',
};

const defaultAuthorImage = `https://ui-avatars.com/api/?name=${encodeURIComponent(
  blogDetail.author
)}&background=1a1b1e&color=cefe00&size=72`;
---

<BaseLayout title={`${blogDetail.title} | Nepal Climate Hub`} description={metaDescription} ogImage={metaImage} ogUrl={metaUrl}>
  <main class="main-container">
    <!-- Header Section -->
    <section class="header-section">
      <Header logoColor="#1A1B1E" />
      <div class="mini-nav">
        <a href="/">Home</a>
        <span style="color: #364FC7">/</span>
        <a href="/blogs">Blogs</a>
      </div>
    </section>

    <!-- Blog Detail Section -->
    <section class="blog-detail-section">
      <div class="blog-container">

        <!-- Blog Title -->
        <header class="blog-header">
          <h1 class="blog-title">{blogDetail.title}</h1>
          <AuthorInfoandShareBlog
            authorName={blogDetail.author}
            authorImageUrl={blogDetail.authorImageUrl || ''}
            date={blogDetail.publishedDate}
            readTime={blogDetail.readingTime} />
        </header>

        <!-- Grid Layout -->
        <div class="blog-grid">

          <!-- LEFT: Blog Content -->
          <article class="blog-content">
            <HtmlRenderer content={blogDetail.content} />
          </article>

          <!-- RIGHT: Sidebar -->
          {
            !isMobile && (
              <aside class="blog-sidebar">

            <section class="sidebar-section">
              <BlogHighlights title="Top Reads" blogs={latestBlogs} />
            </section>
            
            <section class="sidebar-section stay-connected">
              <h2 class="sidebar-title">Stay Connected</h2>
              <EmailSubscriptionForm formBtnVariant="primary" />
            </section>
            
            <section class="sidebar-section">
              <BlogHighlights title="Latest Blogs" blogs={latestBlogs} />
            </section>

          {
            blogDetail.tags.length >  0 && (
              <section class="sidebar-section">
                <h2 class="sidebar-title">Tags</h2>
                <div class="tags-container">
                  {blogDetail.tags.map((tag) => (
                    <span class="tag">{tag?.tag}</span>
                  ))}
                </div>
              </section>
            )
          }
          </aside>
            )
          }

        </div>

        {
          !isMobile && (
            <section class="author-section">
              <AboutBlogAuthor
                authorName={blogDetail.author}
                authorImageUrl={defaultAuthorImage}
                authorBio={'Climate Storyteller at Nepal Climate Hub'}
                authorDescription={'Dipika Khadka is pursuing a Masterâ€™s Degree in Environmental Science and is passionate about geospatial science and climate action. She served as Content and Media Coordinator at NYCA and believes meaningful storytelling drives action. Dipika thrives on connecting with people, learning from diverse perspectives, and blending science and creativity to inspire awareness and community-driven climate solutions.'}
                socials={socials}
                />
           </section>
          )
        }
      </div>
    </section>

    <section class="footer-section">
      <Footer />
    </section>
  </main>
</BaseLayout>

<style>

  .header-section, .blog-detail-section {
    padding: 0px 48px;
  }

  .footer-section {
    background-color: #1a1b1e;
    color: white;
  }

  .blog-detail-section{
    margin-top: 24px;
    padding: 0 48px 80px 48px;
  }

  .blog-container {
}

/* Header */
.blog-header {
  margin-bottom: 16px;
}

.blog-title {
  font-size: 32px;
  font-weight: 700;
  color: #111827;
  margin-bottom: 16px;
}

.blog-meta {
  display: flex;
  gap: 24px;
  font-size: 14px;
  color: #6b7280;
}

/* Grid Layout */
.blog-grid {
  display: grid;
  grid-template-columns: 1fr minmax(300px, 35%);
  gap: 40px;
}

/* Left Content */
.blog-content {
  width: 100%;
}

/* Sidebar */
.blog-sidebar {
  display: flex;
  flex-direction: column;
  gap: 32px;
}

/* Sidebar Sections */
.sidebar-section {
  width: 100%;
}

.sidebar-title {
  font-size: 24px;
  line-height: 24px;
  font-weight: 600;
  margin-bottom: 16px;
  color: #111827;
}

/* Stay Connected Styling */
.stay-connected {
  background-color: #1a1b1e;
  padding: 32px;
  border-radius: 16px;
}

.stay-connected .sidebar-title {
  color: #ffffff;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.tags-container .tag {
  background-color: #ffffff;
  color: #364fc7;
  padding: 6px 12px;
  border: 1px solid #cefe00;
  border-radius: 20px;
  font-size: 14px;
}

.author-section {
  margin-top: 64px;
}

@media screen  and (max-width: 1200px) {
  .blog-detail-section {
    padding: 0 48px 32px 48px;
  }

  .blog-grid {
    grid-template-columns: 1fr;
  }
}

/* Responsive */
@media screen and (max-width: 768px) {
   .header-section {
    padding: 0;
  }


  .blog-detail-section {
    padding: 0 24px 32px 24px;
  }

  .blog-sidebar {
    display: none;
  }

  .blog-title {
    font-size: 20px;
  }

  .aside,.author-section{
    display: none;
  }
}
</style>
